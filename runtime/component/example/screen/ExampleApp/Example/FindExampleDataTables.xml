<?xml version="1.0" encoding="UTF-8"?>
<!--
This Work is in the public domain and is provided on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied,
including, without limitation, any warranties or conditions of TITLE,
NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A PARTICULAR PURPOSE.
You are solely responsible for determining the appropriateness of using
this Work and assume any risks associated with your use of this Work.

This Work includes contributions authored by David E. Jones, not as a
"work for hire", who hereby disclaims any copyright to the same.
-->
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-1.3.xsd"
        default-menu-title="Find Example in DataTables" allow-extra-path="true">

    <transition name="editExample"><default-response url="../EditExample"/></transition>

    <transition name="getExamples" read-only="true">
        <path-parameter name="sColumns"/>
        <path-parameter name="iDisplayStart"/>
        <path-parameter name="iDisplayLength"/>
        <path-parameter name="mDataProp_0"/>
        <path-parameter name="mDataProp_1"/>
        <path-parameter name="mDataProp_2"/>
        <path-parameter name="sSearch"/>
        <path-parameter name="bRegex"/>
        <path-parameter name="sSearch_0"/>
        <path-parameter name="bRegex_0"/>
        <path-parameter name="bSearchable_0"/>
        <path-parameter name="sSearch_1"/>
        <path-parameter name="bRegex_1"/>
        <path-parameter name="bSearchable_1"/>
        <path-parameter name="sSearch_2"/>
        <path-parameter name="bRegex_2"/>
        <path-parameter name="bSearchable_2"/>
        <path-parameter name="iSortCol_0"/>             <!-- column index that is sorted -->
        <path-parameter name="sSortDir_0"/>             <!-- sorted direction: asc or desc -->
        <path-parameter name="iSortingCols"/>
        <path-parameter name="bSortable_0"/>
        <path-parameter name="bSortable_1"/>
        <path-parameter name="bSortable_2"/>
        <!-- More parameters may be added if needed. e.g. more than one sortCol etc. -->
        <actions>
            <set field="pageSize" from="iDisplayLength" type="Integer"/>
            <set field="tmpDisplayStart" from="iDisplayStart" type="Integer"/>
            <set field="pageIndex" from="tmpDisplayStart/pageSize" type="Integer"/>

            <!-- tableFieldList is always consistent order of fields in form-list no matter it is hidden or not.
                 so the sortField from browser could be recognized by tableFieldList[index]-->
            <set field="tableFieldList" from='["ids","exampleId","exampleName","exampleTypeEnumId","statusId","description","editAction"]'/>
            <script>
                def sortFieldIndex = iSortCol_0 as Integer
                def sortFieldDirection = (sSortDir_0 == "asc" ? "+" : "-")

                def sortField = sortFieldDirection + tableFieldList[sortFieldIndex]
            </script>
            <entity-find entity-name="Example" list="exampleList">
                <search-form-inputs input-fields-map="context" paginate="true"/>
                <order-by field-name="${sortField}" />
            </entity-find>
            <entity-find entity-name="ExampleStatusItem" list="exampleStatusItemList"/>
            <entity-find entity-name="moqui.basic.Enumeration" list="exampleTypeList">
                <econdition field-name="enumTypeId" value="ExampleType"/>
            </entity-find>
            <script>
                def respMap = [:]
                respMap.put("iTotalRecords", exampleListCount)
                respMap.put("iTotalDisplayRecords", exampleListCount)
                respMap.put("sEcho","success")

                def aaData =[]
                for (def example in exampleList) {
                    def dataResp = [:]
                    <!-- allow client DataTables AJAX have checkbox in the first column -->
                    <!-- value of checkbox is the exampleId -->
                    dataResp.put("ids", example["exampleId"]);

                    dataResp.put("exampleId", example["exampleId"]);
                    dataResp.put("exampleName", example["exampleName"]);
                    dataResp.put("exampleTypeEnumId", example["exampleTypeEnumId"]);
                    <!-- Add exampleType which is the entry-name for field exampleTypeEnumId in form-list,
                         so data-tables will use exampleType to render the column for exampleTypeEnumId -->
                    exampleType = exampleTypeList.grep { elem -> elem["enumId"] == example["exampleTypeEnumId"] }
                    if (dataSourceType) {
                        dataResp.put("exampleType", exampleType[0]["description"]?:"");
                    } else {
                        dataResp.put("exampleType", "");
                    }

                    dataResp.put("statusId", example["statusId"]);
                    status = exampleStatusItemList.grep { elem -> elem["statusId"] == example["statusId"] }
                    if (dataSourceType) {
                        dataResp.put("status", status[0]["description"]?:"");
                    } else {
                        dataResp.put("status", "");
                    }

                    dataResp.put("description", example["description"]);

                    <!-- allow client DataTables AJAX have action buttons in the last column -->
                    dataResp.put("editAction", "Edit");
                    aaData.add(dataResp)
                }
                respMap.put("aaData", aaData)
            </script>
            <script>ec.web.sendJsonResponse(respMap)</script>
        </actions>
        <default-response type="none"/>
    </transition>

    <pre-actions>
        <!-- datatables css and js. only defined in the pages that needs them to avoid always download them in pages that do not need them. -->

        <set field="html_stylesheets" from="html_stylesheets + ['/assets/lib/data-tables/DT_bootstrap.css']"/>
        <set field="html_scripts" from="html_scripts + ['/assets/lib/data-tables/jquery.dataTables.js', '/assets/lib/data-tables/DT_bootstrap.js']"/>
        <set field="html_scripts" from="html_scripts + ['/assets/js/datatable.js']"/>
    </pre-actions>

    <actions>
        <entity-find entity-name="Example" list="exampleList">
            <search-form-inputs default-order-by="^exampleName"/>
            <econdition field-name="exampleId" value="NULL_EXAMPLE_ID"/>
        </entity-find>
        <entity-find entity-name="ExampleStatusItem" list="exampleStatusItemList"/>
        <entity-find entity-name="moqui.basic.StatusItem" list="statusItemList"/>
        <entity-find entity-name="moqui.basic.Enumeration" list="exampleTypeList">
            <econdition field-name="enumTypeId" value="ExampleType"/>
        </entity-find>
    </actions>
    <widgets>
        <container style="row">
            <container style="col-md-12">
            <form-list name="ExampleDataTable" type="data-tables" list="exampleList" ajax-source="getExamples" dynamic="true">
                <field name="ids">
                    <header-field grouped="true"><check><option key="" text=""/></check></header-field>
                    <default-field><check><option key="" text=""/></check></default-field>
                </field>
                <field name="exampleId">
                    <default-field><hidden/></default-field>
                </field>
                <field name="exampleName">
                    <header-field show-order-by="true"><text-line/></header-field>
                    <default-field>
                        <link url="editExample">
                            <parameter name="exampleId" value="exampleId"/>
                        </link>
                    </default-field>
                </field>
                <field name="exampleTypeEnumId" entry-name="exampleType"> <!-- use entry-name as alias field name for the data-tables. -->
                    <header-field show-order-by="true" title="Example Type">
                        <!-- drop-down is the control in the header for filtering form-list items. -->
                        <drop-down allow-empty="true">
                            <list-options list="exampleTypeList" key="${enumId}" text="${description}"/>
                        </drop-down>
                    </header-field>
                    <default-field><display/></default-field>
                </field>
                <field name="statusId" entry-name="status">
                    <header-field show-order-by="true"><drop-down allow-empty="true">
                            <list-options list="statusItemList" key="${statusId}" text="${description}"/>
                    </drop-down></header-field>
                    <default-field title="Status"><drop-down>
                            <list-options list="statusItemList" key="${statusId}" text="${description}"/>
                    </drop-down></default-field>
                </field>
                <field name="description">
                    <header-field show-order-by="true"><text-line/></header-field>
                    <default-field><display/></default-field>
                </field>
                <field name="editAction">
                    <header-field><filter-button/></header-field>
                    <default-field>
                        <link url="editExample" link-type="anchor-button" text="Edit">
                            <parameter name="exampleId" value="exampleId"/>
                        </link>
                    </default-field>
                </field>
                <form-list-column width="30px"><field-ref name="ids"/></form-list-column>
                <form-list-column><field-ref name="exampleId"/></form-list-column>
                <form-list-column><field-ref name="exampleName"/></form-list-column>
                <form-list-column width="280px"><field-ref name="exampleTypeEnumId"/></form-list-column>
                <form-list-column><field-ref name="statusId"/></form-list-column>
                <form-list-column><field-ref name="description"/></form-list-column>
                <form-list-column width="180px"><field-ref name="editAction"/></form-list-column>
            </form-list>
            </container>
      </container>
  </widgets>

</screen>
